#!/usr/local/bin/purc

<!DOCTYPE hvml SYSTEM 'f: FS'>
<hvml target="html">
    <head>
        <base href=$CRTN.base(! "file://$SYS.cwd/" ) hvml:silently />
        <title>Foil Test Workshop</title>
        <style hvml:raw>
header h1 {
    color:red;
    text-align:center
}

.column {
    // display:inline-block;
    width:45%;
}

.plain-list {
    list-style-type:none;
}

.case-mark {
    appearance:meter-mark;
    width:1em;
    -foil-candidate-marks:'✗…↷↻✓';
}

.total-progress {
    appearance:progress-bar;
    width:10em;
}
        </style>
    </head>

    <body>
        <init as 'cases' with $FS.list_prt("$SYS.cwd/style-cases", '*.html') />

        <header>
            <h1>Foil Test Workshop (totally $DATA.count($cases) cases)</h1>
        </header>

        <archetype name="caseItem">
            <li>
                <meter class="case-mark" id="caseMark$?" value="20" min="0" max="100" low="20" high="80" optimum="90"></meter>
                <span class="case-name">$?</span>
            </li>
        </archetype>

        <div>
            <ul class="plain-list">
                <iterate on $cases>
                    <choose on $STR.substr($?, 0, -5L) >
                        <update on $@ to 'append' with $caseItem />
                        <update on $cases at "[$2%]" with $? />
                    </choose>
                </iterate>
            </ul>
            <p>
                <label for="totalProgress">Total Progress: </label>
                <progress id="totalProgress" class="total-progress" value="0" max="$DATA.count($cases)"></progress>
            </p>
        </div>

        <request on $RDR to 'createPlainWindow' >
            {
                 data: {
                        name: 'test',
                        title: 'The off screen plain window for testing',
                        arg: 'screenshot.txt',
                        class: '-off-screen',
                        layoutStyle: 'rows:25;columns:80',
                 },
            }
        </request>

        <init as caseIdx at '_root' with 0L />

        <observe on $CRTN for 'idle'>
            <choose on $cases[$caseIdx] >
                <load from 'test-foil-worker.hvml' onto 'test' >
                    {
                        case: $?,
                    }

                    <catch for `ANY`>
                        $STREAM.stdout.writelines("Failed to run case $3? (exception: $?.name, $?.info)")
                        <exit with "Failed to run case $3? (exception: $?.name)" />
                    </catch>

                </load>

                <update on "#caseMark$?" at 'attr.value' with "40" />

                <request on $RDR to 'callMethod' >
                    {
                         element: "main",
                         property: "plainwin:test",
                         data: {
                                method: 'dumpContents',
                                arg: "screenshot-$?.txt"
                         },
                    }
                </request>

                <update on "#caseMark$?" at 'attr.value' with "60" />

                <update on "#caseMark$?" at 'attr.value' with "80" />

                <update on "#caseMark$?" at 'attr.value' with "100" />

                <init as 'caseIdx' at '_root' with $DATA.arith('+', $caseIdx, 1L) />
                <update on "#totalProgress" at 'attr.value' with "$caseIdx" />

                <test with $L.ge($caseIdx, $DATA.count($cases)) >
                    <exit with 'Ok' />
                </test>
            </choose>
        </observe>

    </body>
</hvml>

